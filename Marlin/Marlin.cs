/*
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMH6:+HMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMHMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMH6:+bMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMH+:+bMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM6:::jMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMb.:::jHMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMH6:::jHMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMj.::::::6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMHj::.:jMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMH::.::::::bMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM6:.:::jHMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMj::..:::+::jMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMHj:.::.:bMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMH+..:::::::::+MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMHj:.::::jMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMM+:::::::.::.::6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM6::.:++:+bMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMM+..::::::..:::.:bMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMHj::.:j+j:6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMj:.::::::+:.:.::...+HMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb+...:66jj+6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMM+::::::::::::..............::+bMMMMMMMMMMMMMMMMMMMMMMMMMMMMb+..:+6H6b6:6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMM6..:::::::::.::..jjj6jj++::::::::.:+bMMMMMMMMMMMMMMMMMMMH+..:.+HH6jj++jMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMb:::::::::....:::.............::...........:+j6bbbb6j:....:+bMHb6+:jj+HMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMH:..:+++::::::::.....::+j6j+++:...........:::+:...:.....:+6MH66j++6666bMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMM6::::::::.::.....:+j+:............................:j6j+bHMMMb6j+j6bbbb6MMMMMMMMb66j6bMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMM+.:::........+j:.:...............................:::j6j6MHb6b+66bbbbbbbMH6+:++6b6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMb:.::+:.....:jj.......................:.........:6bHH6+j6MHbj+j6j6bbb6+:::j66bHbbMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMM6:::::....+j+.........................::....::j6bHbbbbHHMHb6::::++::::jbHb66HHbMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMM6:::....:++:........................:..:::+66bHHHHMMHHMMMbH6H6:+++6bHHb666bHb6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMM+:::...j+...........................:.:::jbbHHHHMMMMMMMMMHb++:j6HMHHb6j6bHb6bMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMM+.::..+j..................:....::...:::j6bHb6j6HMMMMMMMMb6j+jbMMMb6666bbbbbbMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMj....:b+.................:...:.:.:::+6bHHHHHbbHHbb6j666bHHbbjjbbbbbbbj6b66bbMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMj::..j:.......::..........::....::+bbHHHHHHHHMMHMHHbHMMMMMMbb+6j66++66666HbMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMM6.:.++.........::......:...::::+6bbHHHHHHbHHMMMMMMMMMMMMMMHbb+:++j6b6jj6bbMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMM:.+:............::...:...:.+6bbbHHHHHbHHHMMMMMMMMMMMMMMHbbbHHbMHMHbbHb6jMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMb:................::......:+jbHHHHHHHHb6j6HHHHMMMMMMMHb6bbH666HbMbb6bb6bMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMH:..................:...::+j6bbHHHbHHHH6jb66jbbbbHb66bbbbjj6b6bbHb66bjHMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMH:........:..........:::+6bbHHbHbHHMMMMMMH66Hbj+jjjj6H6++jHb6bjb6bbHbMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMH:..................::+bbHbHbHHHMMMMMMMMMH66bbbb6j6+.+jjjjj666H66jHMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMM6............:....:+j6j+::.................::+jjj66+:bHHj++jj++6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMj.................::+j6b6bbb6bb66j666j6666j6+:..jjj++::jbbb++HMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMj.......:+jbbHHHMHHMMMMMHHMHbbbbHHbbHHHbbHb6j+++:+6bj:jj+::+:+::+bMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMM+.:+6bHHb6++:jbbbHMMMMMMMMMMMMMMMMMMMMMMMMHHbbj+j6:+jHMMMMMMMHbjjj++:6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMj:jH6+:......:jbbHMMMMMMMMMMMMMMMMMMMMMMMHbbbbb66bb:+:HMMMMMMMMMMMMMMMMH66+jHMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MbHMMM.....:.:jbHHMMMMMMMMMMMMMMMMMMMMHHHHHHH6666bjbb+MjjMMMMMMMMMMMMMMMMMMMMMMMH6+HMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMH:....:+bHHHMMMMMMMMMMMMMMMMMMMHHHMbb6b66bHjHMj6MM+MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMM6....:+bHHMMMMMMMMMMMMMMMMMMHHMHbbb6bMMMb6HMHjMMMHHMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMb.:.:+bHMMMMMMMMMMMMMMMMHHHMHHMHMMMH6HMMMMM6MMMMMbMMMMMMMMMMMMMMMMMMMMMMMMMMH+bMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMM..:+6bMMMMMMMMMMMMMMHHMHHHMHMHHj:.:HMMMMH6MMMMMbHMMMMMMMMMMMMMMMMMMMMMMMMb:jMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMM+.:+66MMMMMMMMMMMMHHHHMHMHMMb:::...+MMMbHMMMMMMbMMMMMMMMMMMMMMMMMMMMMMMM::6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMb:+jj6b6HMMMMMMMHHHbbbbHM6:....:j:..bMHMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMj:.jMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMM6+j++j6bHHHMMMHbbb6bMMb.........+:.:HMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMH:..+MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMM6+:+jj6bbMHHHbbb6bMb............:j..bMMMMMMMMMMMMMMMMMMMMMMMMMMMMj....MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMbbjj+j66bHb6666M+..:....:........:+.:HMMMMMMMMMMMMMMMMMMMMMMMMM:..:.jMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMHjj+++j++6jj6H.::jj+..:...........:+.+MMMMMMMMMMMMMMMMMMMMMMM+.::.jMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMM66j+++++jjb:.+jjbb6b+.............+j.+HMMMMMMMMMMMMMMMMMMH:....:HMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMb6666::j6..::jbHHbHb6j+............:6:...:6bHHMMMMMMMMM6:....:6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMM6+6+jj..:++jjbHbHHbb6j+:............++:.....6MMMMMMMH:.....+MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMM6+j:...:::+j6bHHHMbb66j:............:j+....6MMMMMH:......6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMM.......::++jbbHHHMHbbbb6++:............+6+..+HMMj......:MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMM.:..::..:::++jbbbbMHMHHHbb6jj+:............:+j+:.......+MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMM::.++++:::::::+jj6bHHHMHMMHHHbbb6+:..............::.:..6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMM::.++jjj6jj6+::+++j+jj66bbHHHHHHHHbbbj+::..............bMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMM+:++jjj6j+:.::6bbbb66j6jj++jjj6666b66bbHbbbbbb66j+::...jMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMj+j+jjjjHMMMMHj+++::+j6bHMMbbbbbb6b6jjjjjj66++::+jjj+:.6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMH+jjjjbMMMMMMMMMMMMMMMMMMMH+j6j+:.::::::::jj6666:::....6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMj:j6jMMMMMMMMMMMMMMMMMMMMMMMMMMMMMH+:::HMMMMMMMj......:HMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMH+:+bMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMHbMMMMMMMMM+.:::::bMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMM+:jMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM+.....+MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMjjMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM6....:+MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMM6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM6...:.jMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb..:..jMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMb:..::6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMH:...:6MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
*/
namespace Marlin
{
    using System;
    using System.IO;
    using System.Linq;
    using System.Net;
    using System.Threading.Tasks;
    using org.apache.hadoop.hbase.rest.protobuf.generated;
    using ProtoBuf;
    using Version = org.apache.hadoop.hbase.rest.protobuf.generated.Version;

    /// <summary>
    /// Marlin is a C# connector to HBase. 
    /// 
    /// It currently targets HBase 0.96.2 and HDInsight 3.0 on Microsoft Azure.
    /// The communication works through HBase REST (StarGate) which uses ProtoBuf as a serialization format.
    /// 
    /// The usage is quite simple:
    /// 
    /// <code>
    /// var credentials = ClusterCredentials.FromFile("credentials.txt");
    /// var marlin = new Marlin(credentials);
    /// 
    /// var version = await marlin.GetVersionAsync();
    /// 
    /// Console.WriteLine(version);
    /// 
    /// </code>
    /// </summary>
    public class Marlin
    {
        private readonly ClusterCredentials _credentials;
        private readonly WebRequester _requester;

        public Marlin(ClusterCredentials credentials)
        {
            if (credentials == null)
            {
                throw new System.ArgumentNullException("credentials");
            }
            _credentials = credentials;
            _requester = new WebRequester(credentials);
        }

        public Version GetVersion()
        {
            return GetVersionAsync().Result;
        }

        public async Task<Version> GetVersionAsync()
        {
            return await GetRequestAndDeserialize<Version>("version");
        }

        public TableList ListTables()
        {
            return ListTablesAsync().Result;
        }

        public async Task<TableList> ListTablesAsync()
        {
            return await GetRequestAndDeserialize<TableList>("");
        }

        public StorageClusterStatus GetStorageClusterStatus()
        {
            return GetStorageClusterStatusAsync().Result;
        }

        public async Task<StorageClusterStatus> GetStorageClusterStatusAsync()
        {
            return await GetRequestAndDeserialize<StorageClusterStatus>("/status/cluster");
        }

        public TableSchema GetTableSchema(string table)
        {
            return GetTableSchemaAsync(table).Result;
        }

        public async Task<TableSchema> GetTableSchemaAsync(string table)
        {
            if (table == null || !table.Any()) { throw new ArgumentException("Table was either null or empty!"); }
            return await GetRequestAndDeserialize<TableSchema>(table + "/schema");
        }

        public TableInfo GetTableInfo(string table)
        {
            return GetTableInfoAsync(table).Result;
        }

        public async Task<TableInfo> GetTableInfoAsync(string table)
        {
            if (table == null || !table.Any()) { throw new ArgumentException("Table was either null or empty!"); }
            return await GetRequestAndDeserialize<TableInfo>(table + "/regions");
        }

        /// <summary>
        /// Creates a table and/or fully replaces its schema.
        /// </summary>
        /// <param name="schema">the schema</param>
        /// <returns>returns true if the table was created, false if the table already exists. In case of any other error it throws a WebException.</returns>
        public bool CreateTable(TableSchema schema)
        {
            return CreateTableAsync(schema).Result;
        }

        /// <summary>
        /// Creates a table and/or fully replaces its schema.
        /// </summary>
        /// <param name="schema">the schema</param>
        /// <returns>returns true if the table was created, false if the table already exists. In case of any other error it throws a WebException.</returns>
        public async Task<bool> CreateTableAsync(TableSchema schema)
        {
            if (schema == null) { throw new ArgumentException("Schema was null!"); }
            if (schema.name == null || !schema.name.Any()) { throw new ArgumentException("TableName was either null or empty!"); }
            var webResponse = await PutRequest(schema.name + "/schema", schema);

            if (webResponse.StatusCode == HttpStatusCode.Created) { return true; }
            // table already exits
            if (webResponse.StatusCode == HttpStatusCode.OK) { return false; }

            // throw the exception otherwise
            using (var output = new StreamReader(webResponse.GetResponseStream()))
            {
                var message = output.ReadToEnd();
                throw new WebException(
                    string.Format(
                    "Couldn't create table {0}! Response code was: {1}, expected either 200 or 201! Response body was: {2}",
                    schema.name, webResponse.StatusCode, message));
            }
        }

        /// <summary>
        /// Modifies a table schema. 
        /// If necessary it creates a new table with the given schema. 
        /// If something went wrong, a WebException is thrown.
        /// </summary>
        /// <param name="tableName">the table name</param>
        /// <param name="schema">the schema</param>
        public void ModifyTableSchema(string tableName, TableSchema schema)
        {
            ModifyTableSchemaAsync(tableName, schema).Wait();
        }

        /// <summary>
        /// Modifies a table schema. 
        /// If necessary it creates a new table with the given schema. 
        /// If something went wrong, a WebException is thrown.
        /// </summary>
        /// <param name="table">the table name</param>
        /// <param name="schema">the schema</param>
        public async Task ModifyTableSchemaAsync(string table, TableSchema schema)
        {
            if (table == null || !table.Any()) { throw new ArgumentException("TableName was either null or empty!"); }
            if (schema == null) { throw new ArgumentException("Schema was null!"); }
            var webResponse = await PostRequest<TableSchema>(table + "/schema", schema);
            if (webResponse.StatusCode != HttpStatusCode.OK || webResponse.StatusCode != HttpStatusCode.Created)
            {
                using (var output = new StreamReader(webResponse.GetResponseStream()))
                {
                    var message = output.ReadToEnd();
                    throw new WebException(
                        string.Format(
                        "Couldn't modify table {0}! Response code was: {1}, expected either 200 or 201! Response body was: {2}",
                        table, webResponse.StatusCode, message));
                }
            }
        }

        /// <summary>
        /// Deletes a table.
        /// If something went wrong, a WebException is thrown.
        /// </summary>
        /// <param name="tableName">the table name</param>
        public void DeleteTable(string tableName)
        {
            DeleteTableAsync(tableName).Wait();
        }

        /// <summary>
        /// Deletes a table.
        /// If something went wrong, a WebException is thrown.
        /// </summary>
        /// <param name="table">the table name</param>
        public async Task DeleteTableAsync(string table)
        {
            if (table == null || !table.Any()) { throw new ArgumentException("TableName was either null or empty!"); }
            var webResponse = await DeleteRequest<TableSchema>(table + "/schema", null);

            if (webResponse.StatusCode != HttpStatusCode.OK)
            {
                using (var output = new StreamReader(webResponse.GetResponseStream()))
                {
                    var message = output.ReadToEnd();
                    throw new WebException(
                        string.Format(
                        "Couldn't delete table {0}! Response code was: {1}, expected 200! Response body was: {2}",
                        table, webResponse.StatusCode, message));
                }
            }
        }

        /// <summary>
        /// Stores the given cells in the supplied table.
        /// </summary>
        /// <param name="table">the table</param>
        /// <param name="cells">the cells to insert</param>
        public void StoreCells(string table, CellSet cells)
        {
            StoreCellsAsync(table, cells).Wait();
        }

        /// <summary>
        /// Stores the given cells in the supplied table.
        /// </summary>
        /// <param name="table">the table</param>
        /// <param name="cells">the cells to insert</param>
        /// <returns>a task that is awaitable, signifying the end of this operation</returns>
        public async Task StoreCellsAsync(string table, CellSet cells)
        {
            if (table == null || !table.Any()) { throw new ArgumentException("TableName was either null or empty!"); }
            if (cells == null) { throw new ArgumentException("CellSet was null!"); }

            // note the fake row key to insert a set of cells
            var webResponse = await PutRequest(table + "/somefalsekey", cells);
            if (webResponse.StatusCode != HttpStatusCode.OK)
            {
                using (var output = new StreamReader(webResponse.GetResponseStream()))
                {
                    var message = output.ReadToEnd();
                    throw new WebException(
                        string.Format(
                        "Couldn't insert into table {0}! Response code was: {1}, expected 200! Response body was: {2}",
                        table, webResponse.StatusCode, message));
                }
            }
        }

        public CellSet GetCells(string tablename, string rowKey)
        {
            return GetCellsAsync(tablename, rowKey).Result;
        }

        // TODO add timestamp, versions and column queries
        public async Task<CellSet> GetCellsAsync(string tableName, string rowKey)
        {
            if (tableName == null || !tableName.Any()) { throw new ArgumentException("TableName was either null or empty!"); }
            if (rowKey == null) { throw new ArgumentException("RowKey was null!"); }
            return await GetRequestAndDeserialize<CellSet>(tableName + "/" + rowKey);
        }

        internal async Task<HttpWebResponse> PutRequest<TReq>(string endpoint, TReq request)
        {
            return await ExecuteMethod("PUT", endpoint, request);
        }

        internal async Task<HttpWebResponse> DeleteRequest<TReq>(string endpoint, TReq request)
        {
            return await ExecuteMethod("DELETE", endpoint, request);
        }

        internal async Task<HttpWebResponse> PostRequest<TReq>(string endpoint, TReq request)
        {
            return await ExecuteMethod("POST", endpoint, request);
        }

        internal async Task<HttpWebResponse> ExecuteMethod<TReq>(string method, string endpoint, TReq request)
        {
            // TODO make the buffer size configurable 
            using (var input = new MemoryStream())
            {
                if (request != null)
                {
                    Serializer.Serialize(input, request);
                }
                return await _requester.IssueWebRequestAsync(endpoint, method: method, input: input);
            }
        }

        internal async Task<T> GetRequestAndDeserialize<T>(string endpoint)
        {
            using (var responseStream = (await _requester.IssueWebRequestAsync(endpoint, method: "GET")).GetResponseStream())
            {
                return Serializer.Deserialize<T>(responseStream);
            }
        }
    }
}
